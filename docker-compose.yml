services:
  # =========================================
  # Backend PHP-FPM (Laravel)
  # =========================================
  app:
    build:
      context: .                 # Usa Dockerfile del directorio actual
      dockerfile: Dockerfile
    container_name: civis-app
    restart: unless-stopped

    # Volumen para desarrollo: sincroniza archivos locales automáticamente
    volumes:
      - ./:/var/www/app
      - /var/www/app/vendor  # Excluir vendor para usar el del contenedor

    networks:
      - laravel
    depends_on:
      - db
    environment:
      # =========================================
      # BASE DE DATOS
      # =========================================
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=civis
      - DB_USERNAME=civis
      - DB_PASSWORD=civis_password_example

      # =========================================
      # LARAVEL CORE
      # =========================================
      # ¡Crítico! generar con docker exec civis-app php artisan key:generate --show
      - APP_KEY=${APP_KEY:-base64:nSviGSC8VQeAsA13TSIjUQ9DszFz0IRtHGuFrDLyhVk=}
      - APP_NAME=CIVIS
      - APP_ENV=local                   # local | production
      - APP_DEBUG=true                  # true para dev, false para prod
      - APP_URL=http://civis.local      # URL base del backend

      # =========================================
      # CORS - Orígenes permitidos (separados por coma)
      # =========================================
      # Cambia esto para permitir otros dominios
      - CORS_ALLOWED_ORIGINS=http://civis.local,http://localhost,http://127.0.0.1

      # =========================================
      # FRONTEND - URL de la API para JavaScript
      # =========================================
      # Se inyecta en public/js/config.env.js al iniciar
      - FRONTEND_API_URL=http://civis.local/api

      # =========================================
      # SANCTUM/SESSION
      # =========================================
      - SANCTUM_STATEFUL_DOMAINS=civis.local,localhost,127.0.0.1
      - SESSION_DRIVER=database

    ports:
      - "9000"

  # =========================================
  # Nginx (proxy y servidor estático)
  # =========================================
  nginx:
    image: nginx:1.29.4-alpine
    container_name: civis-nginx
    restart: unless-stopped

    ports:
      - "80:80"  # Accede en http://civis.local

    volumes:
      # Vincular el contenido local para desarrollo
      - ./:/var/www/app
      - /var/www/app/vendor  # Excluir vendor
      # Configuración de nginx
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d

    networks:
      - laravel
    depends_on:
      - app

  # =========================================
  # PostgreSQL
  # =========================================
  db:
    image: postgres:15-alpine
    container_name: civis-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: civis
      POSTGRES_USER: civis
      POSTGRES_PASSWORD: civis_password_example

    volumes:
      - db_data:/var/lib/postgresql/data

    networks:
      - laravel
    # Descomenta para conectar con DBeaver/TablePlus:
    ports:
      - "5432:5432"

# =========================================
# Red interna entre servicios
# =========================================
networks:
  laravel:

# =========================================
# Volumen persistente de la base de datos
# =========================================
volumes:
  db_data:
  vendor_cache:
  storage:
  app_laravel:
